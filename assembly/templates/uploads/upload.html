{% extends 'base.html' %}

{% block title %}Upload File - Voice to Text Converter{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="text-center mb-5">
            <h1 class="text-gradient mb-3">
                <i class="bi bi-cloud-upload-fill me-3"></i>
                Upload Audio File
            </h1>
            <p class="lead text-muted">
                Upload your audio file and convert it to text using advanced AI transcription
            </p>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}

                    <!-- Drag and Drop Zone -->
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon mb-3">
                            <i class="bi bi-cloud-upload" style="font-size: 4rem; color: var(--primary-color);"></i>
                        </div>
                        <h4 class="mb-3">Drag & Drop Your Audio File</h4>
                        <p class="text-muted mb-4">
                            or click to browse files
                        </p>

                        <!-- Hidden Django file input -->
                        <div style="display: none;">
                            {{ form.file }}
                        </div>

                        <div class="upload-info">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Supported formats: MP3, WAV, M4A, FLAC (Max size: 100MB)
                            </small>
                        </div>
                    </div>

                    <!-- File Info Display -->
                    <div id="fileInfo" class="mt-4" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-file-earmark-music-fill me-3" style="font-size: 2rem;"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1" id="fileName"></h6>
                                <small class="text-muted" id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFile()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Uploading...</small>
                            <small class="text-muted" id="progressText">0%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 0%"
                                 id="progressBar">
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'file_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>
                            Back to Files
                        </a>
                        <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                            <i class="bi bi-upload me-2"></i>
                            Upload File
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Additional Info -->
        <div class="row mt-5">
            <div class="col-md-4 text-center mb-3">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <i class="bi bi-lightning-charge-fill text-warning mb-3" style="font-size: 2rem;"></i>
                        <h6>Fast Processing</h6>
                        <small class="text-muted">AI-powered transcription in seconds</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center mb-3">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <i class="bi bi-globe text-info mb-3" style="font-size: 2rem;"></i>
                        <h6>Multi-Language</h6>
                        <small class="text-muted">Support for English and Hindi</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center mb-3">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <i class="bi bi-shield-check text-success mb-3" style="font-size: 2rem;"></i>
                        <h6>Secure</h6>
                        <small class="text-muted">Your files are processed securely</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('id_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    fileInput.setAttribute('accept', 'audio/*');

    uploadZone.addEventListener('click', () => fileInput.click());

    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    ['dragover', 'dragenter'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
    });

    uploadZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            fileInput.files = files;
            displayFileInfo(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            displayFileInfo(e.target.files[0]);
        }
    });

    function displayFileInfo(file) {
        if (!file.type.startsWith('audio/')) {
            showToast('Please select a valid audio file.', 'danger');
            clearFile();
            return;
        }
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
            showToast('File exceeds the 100MB size limit.', 'danger');
            clearFile();
            return;
        }
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        uploadBtn.disabled = false;
        uploadZone.innerHTML = `
            <div class="d-flex align-items-center justify-content-center py-3">
                <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 2rem;"></i>
                <div>
                    <h6 class="mb-0">File Ready</h6>
                    <small class="text-muted">Click "Upload File" to proceed</small>
                </div>
            </div>`;
    }

    window.clearFile = function() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        uploadBtn.disabled = true;
        uploadZone.innerHTML = `
            <div class="upload-icon mb-3">
                <i class="bi bi-cloud-upload" style="font-size: 4rem; color: var(--primary-color);"></i>
            </div>
            <h4 class="mb-3">Drag & Drop Your Audio File</h4>
            <p class="text-muted mb-4">or click to browse files</p>
            <div class="upload-info"><small class="text-muted"><i class="bi bi-info-circle me-1"></i>Supported formats: MP3, WAV, M4A, FLAC (Max size: 100MB)</small></div>`;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!fileInput.files.length) {
            showToast('Please select a file first', 'warning');
            return;
        }

        // --- THE FIX: Manually construct FormData ---
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', this.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('file', fileInput.files[0], fileInput.files[0].name);

        const xhr = new XMLHttpRequest();

        xhr.open('POST', uploadForm.action, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = percentComplete + '%';
            }
        });

        xhr.onloadstart = function() {
            uploadProgress.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
        };

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                        showToast('File uploaded successfully!', 'success');
                        setTimeout(() => {
                            window.location.href = "{% url 'file_list' %}";
                        }, 1000);
                    } else {
                        // Display server-side form validation errors
                        const errors = JSON.parse(response.errors);
                        const fileError = errors.file ? errors.file[0].message : 'Unknown error';
                        showToast('Upload failed: ' + fileError, 'danger');
                        resetUploadUI();
                    }
                } catch (e) {
                    showToast('An error occurred processing the server response.', 'danger');
                    resetUploadUI();
                }
            } else {
                showToast('An server error occurred (' + xhr.status + '). Please try again.', 'danger');
                resetUploadUI();
            }
        };

        xhr.onerror = function() {
            showToast('A network error occurred. Please check your connection.', 'danger');
            resetUploadUI();
        };

        xhr.send(formData);
    });

    function resetUploadUI() {
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Upload File';
    }

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
</script>
{% endblock %}
